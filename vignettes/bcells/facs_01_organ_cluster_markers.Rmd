---
title: "B Cells FACS"
output: html_notebook
---
```{r}
library(Seurat)
library(tidyverse)
library(here)
source(here('vignettes', 'bcells', 'common.R'))

load(here('vignettes', 'bcells', 'tissues_enough_cells.Robj'))
```


How many cells do we have per tissue?

```{r}
table(tiss_tissues_enough_cells@meta.data$tissue)
```

```{r}
tissues.enough.cells = table(tiss_tissues_enough_cells@meta.data$tissue) > 30
tissues.enough.cells = tissues.enough.cells[tissues.enough.cells]
tiss_facs_tissues_enough_cells = SubsetData(tiss_tissues_enough_cells, subset.name='tissue', 
                                            accept.value = names(tissues.enough.cells))
sort(unique(tiss_facs_tissues_enough_cells@meta.data$tissue))
table(tiss_facs_tissues_enough_cells@meta.data$tissue)
dim(tiss_tissues_enough_cells@scale.data)
dim(tiss_facs_tissues_enough_cells@scale.data)
```


## Get differential expression between tissues
```{r}
organ_markers = find_markers(tiss_facs_tissues_enough_cells, 'tissue')
write_csv(organ_markers, here('vignettes', 'bcells', 'facs_tissue_markers.csv'))
head(organ_markers)
```


```{r}
ggplot(data=organ_markers, aes(x=p_val_adj)) + geom_histogram() + facet_grid(~tissue)
```



```{r}
top_organ_markers = organ_markers %>% group_by(tissue) %>% top_n(-10, p_val_adj)
write_csv(organ_markers, here('vignettes', 'bcells', 'facs_tissue_markers_top10_per_tissue.csv'))
genes.to.plot = sort(unique(top_organ_markers$gene))
top_organ_markers
```

```{r}
?sort
```


```{r}
top_organ_markers = organ_markers %>% group_by(tissue) %>% top_n(-3, p_val_adj)
genes.to.plot = sort(unique(top_organ_markers$gene), decreasing=TRUE)
print(length(genes.to.plot))


RidgePlot(tiss_tissues_enough_cells, genes.to.plot, group.by='tissue')
DotPlot(tiss_tissues_enough_cells, genes.to.plot, group.by='tissue')
```


```{r, fig.height=40}
nCol = 4
plots = FeaturePlot(tiss_tissues_enough_cells, features.plot = genes.to.plot, 
                    do.return = TRUE, nCol = nCol, no.axes=TRUE, 
                    # Light grey to 
                    cols.use=c('lightgrey', '#008080'))
for (p in plots){
  gene_name = p$labels$title
  gene_tissues = top_organ_markers %>% filter(gene == p$labels$title) %>% select(tissue)
  gene_tissues = as.character(as.vector(gene_tissues$tissue))
  print(paste(gene_name, paste(gene_tissues)))
  title = paste0(gene_name, ' (', paste(gene_tissues, sep=', '), ')')
  p = p + labs(title=title)
  plots[[gene_name]] = p
}
plots.combined <- plot_grid(plotlist = plots, ncol = nCol)
invisible(x = lapply(X = plots.combined, FUN = print))
ggsave('facs_featureplot_top_organ_markers.pdf', height = 40, width=15)
```


---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*.

```{r}
library(Seurat)
library(here)
library(tidyverse)
dir.create(here('vignettes', 'bcells'))
```


```{r}
tm.droplet.matrix = readRDS(here("data", "TM_droplet_mat.rds"))
tm.droplet.metadata = read_csv(here("data", "TM_droplet_metadata.csv"))
```

```{r}
bcell_ind = grepl('(B cell)|(leukocyte)|(lymphocyte)', tm.droplet.metadata$cell_ontology_class, perl=TRUE)
``` 

```{r}
subset = tm.droplet.matrix[,bcell_ind]
```


```{r}
metadata2 = column_to_rownames(tm.droplet.metadata, "cell")
View(metadata2)
```



```{r}
create_seurat_object = function(raw.data, meta.data, method){
  
  if (method == 'droplet'){
    scale = 1e4
  } else {
    scale = 1e6
  }
  
  # Find ERCC's, compute the percent ERCC, and drop them from the raw data.
  erccs <- grep(pattern = "^ERCC-", x = rownames(x = raw.data), value = TRUE)
  percent.ercc <- Matrix::colSums(raw.data[erccs, ])/Matrix::colSums(raw.data)
  ercc.index <- grep(pattern = "^ERCC-", x = rownames(x = raw.data), value = FALSE)
  raw.data <- raw.data[-ercc.index,]
  
  # Create the Seurat object with all the data
  tiss <- CreateSeuratObject(raw.data = raw.data, project = paste0('b_cells_', method))
  tiss <- AddMetaData(object = tiss, meta.data)
  tiss <- AddMetaData(object = tiss, percent.ercc, col.name = "percent.ercc")

  
  # Calculate percent ribosomal genes.
  ribo.genes <- grep(pattern = "^Rp[sl][[:digit:]]", x = rownames(x = tiss@data), value = TRUE)
  percent.ribo <- Matrix::colSums(tiss@raw.data[ribo.genes, ])/Matrix::colSums(tiss@raw.data)
  tiss <- AddMetaData(object = tiss, metadata = percent.ribo, col.name = "percent.ribo")
  
  if (method == 'facs'){
  # Change default name for sums of counts from nUMI to nReads
  colnames(tiss@meta.data)[colnames(tiss@meta.data) == 'nUMI'] <- 'nReads'
  tiss <- FilterCells(object = tiss, subset.names = c("nGene", "nReads"), 
                      low.thresholds = c(500, 50000))
  } else {
      tiss <- FilterCells(object = tiss, subset.names = c("nGene", "nUMI"), 
                      low.thresholds = c(500, 1000))
  }
  
  tiss <- process_tissue(tiss, scale)
  return (tiss)
}

process_tissue = function(tiss, scale){
  tiss <- NormalizeData(object = tiss, scale.factor = scale)
  tiss <- ScaleData(object = tiss)
  tiss <- FindVariableGenes(object = tiss, do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5)
  tiss <- RunPCA(object = tiss, do.print = FALSE)
  tiss <- ProjectPCA(object = tiss, do.print = FALSE)
}
```


```{r}
methods = c('facs', 'droplet')

for (method in methods){
  matrix = readRDS(here("data", paste0("TM_", method, "_mat.rds")))
  metadata = read.csv(here("data", paste0("TM_", method, "_metadata.csv")), 
                      row.names = 1, stringsAsFactors = FALSE, header=TRUE, sep=",")
  # metadata = column_to_rownames(metadata, "cell")

  # load(robj)

  bcell_ind = grepl('(B cell)|(leukocyte)|(lymphocyte)', metadata$cell_ontology_class, perl=TRUE)
  bcell_ontologies = unique(metadata$cell_ontology_class[bcell_ind])
  print(bcell_ontologies)

  bcell_matrix = matrix[,bcell_ind]
  bcell_metadata = metadata[bcell_ind,]

  tiss_bcells = create_seurat_object(bcell_matrix, bcell_metadata, method)

  filename = here('vignettes', 'bcells', paste0(method, '_bcells.Robj'))
  print(filename)
  if (method == 'droplet'){
    tiss_droplet_bcells = tiss_bcells
    save(tiss_droplet_bcells, file=filename)
  } else {
    tiss_facs_bcells = tiss_bcells
    save(tiss_facs_bcells, file=filename)
  }
}
```


